<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>World Map — Pins + Photos</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    :root{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    body{margin:0;display:flex;flex-direction:column;height:100vh}
    header{padding:10px 16px;background:#0f172a;color:#fff}
    header h1{margin:0;font-size:18px}
    #map{flex:1;min-height:300px}

    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);opacity:0;pointer-events:none;transition:opacity .15s}
    .modal.open{opacity:1;pointer-events:auto}
    .modal-content{background:#fff;border-radius:10px;padding:12px;max-width:1100px;width:94%;max-height:88%;overflow:auto;box-shadow:0 10px 30px rgba(2,6,23,.4)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-header h2{margin:0;font-size:16px}
    .close-btn{background:transparent;border:0;font-size:22px;cursor:pointer}
    .thumbs{display:flex;flex-wrap:wrap;gap:8px}
    .thumbs a{display:block}
    .thumbs img{max-width:220px;max-height:160px;border-radius:6px;display:block}
    @media (max-width:600px){ .thumbs img{max-width:140px;max-height:100px} }

    footer{padding:8px 12px;font-size:13px;background:#f8fafc}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <header>
    <h1>World Map — Click a pin to see up to 10 photos</h1>
  </header>

  <div id="map"></div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 id="modal-title">Photos</h2>
        <button id="close" class="close-btn" aria-label="Close">✕</button>
      </div>
      <div id="gallery"></div>
    </div>
  </div>

  <footer>
    <span class="muted">Data source: public Google Sheet (CSV). Images: public URLs (Google Cloud Storage, Cloudinary, GitHub raw, etc.)</span>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTldb18umlbtlzZgGIgeozfF-oRihc8IVoJ_dSDULPB7mXTRAJSzyk6MAUt5rsW4io92YsZE0Y89U4A/pub?gid=0&single=true&output=csv';

    function collectImages(row){
      const images = [];
      for(let i=1;i<=10;i++){
        const k = 'image'+i;
        if(row[k] && row[k].trim()) images.push(row[k].trim());
      }
      return images;
    }

    const map = L.map('map').setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const modal = document.getElementById('modal');
    const gallery = document.getElementById('gallery');
    const modalTitle = document.getElementById('modal-title');
    document.getElementById('close').addEventListener('click', ()=> closeModal());
    modal.addEventListener('click', (e)=> { if(e.target===modal) closeModal(); });

    function openModal(title, images){
      modalTitle.textContent = title || 'Photos';
      if(!images || images.length===0){
        gallery.innerHTML = '<p>No images for this pin.</p>';
      } else {
        const html = images.map(u => `<a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="${escapeHtml(u)}" alt="photo"/></a>`).join('\n');
        gallery.innerHTML = `<div class="thumbs">${html}</div>`;
      }
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }
    function escapeHtml(str){ return (str+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

    let COUNTRY_CENTROIDS = {};

    function getLatLon(row){
      const lat = parseFloat(row.lat || row.latitude || row.Lat || row.Latitude);
      const lon = parseFloat(row.lon || row.longitude || row.Lon || row.Longitude);
      if(isFinite(lat) && isFinite(lon)) return [lat, lon];
      const code = (row.country_code || row.country || '').trim().toUpperCase();
      if(code && COUNTRY_CENTROIDS[code]) return COUNTRY_CENTROIDS[code].coordinates;
      return null;
    }

    function loadFromSheet(csvUrl){
      if(!csvUrl || csvUrl.includes('REPLACE_SHEET_ID')){
        console.warn('Please set SHEET_CSV_URL to your published Google Sheet CSV URL.');
        return;
      }

      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results){
          const rows = results.data;
          rows.forEach((row, idx) => {
            const coords = getLatLon(row);
            if(!coords) return;

            const images = collectImages(row);
            const title = COUNTRY_CENTROIDS[row.country_code?.trim().toUpperCase()]?.name;
            console.log(`coords: ${coords}. title: ${title}. images: ${images.length}`);

            const marker = L.marker(coords).addTo(map);
            marker.on('click', ()=> openModal(title, images));

            // Calculate the maximum width of the popup based on the widest image
            const maxImageWidth = 100; // This matches the `max-width` of the images in the popup
            const popupWidth = Math.min(images.length * (maxImageWidth + 8), 800); // Limit the popup width to 800px

            // Include all images in the popup text
            const imagesHtml = images
              .map(
                (u) =>
                  `<img src="${escapeHtml(u)}" alt="photo" style="max-width:${maxImageWidth}px;max-height:75px;border-radius:4px;margin:4px;"/>`
              )
              .join('');
            const popupText = `<strong>${escapeHtml(countryName)}</strong><br/>${images.length} image${images.length === 1 ? '' : 's'}<br/>${imagesHtml}`;

            // Set popup options with dynamic width
            const popupOptions = {
              maxWidth: popupWidth,
              minWidth: 300,
            };

            marker.bindPopup(popupText, popupOptions);
          });
        },
        error: function(err){
          console.error('Error loading CSV:', err);
          alert('Failed to load sheet CSV. Make sure the SHEET_CSV_URL is correct and the sheet is published to the web.');
        }
      });
    }

    // Load centroids from external JSON file
    fetch('centroids.json')
      .then(r => r.json())
      .then(data => { COUNTRY_CENTROIDS = data; loadFromSheet(SHEET_CSV_URL); })
      .catch(err => { console.error('Failed to load centroids.json', err); loadFromSheet(SHEET_CSV_URL); });

  </script>
</body>
</html>
