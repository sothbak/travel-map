<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>World Map ‚Äî Pins + Photos</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    :root{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    *{box-sizing:border-box}
    body{margin:0;display:flex;flex-direction:column;height:100vh;overflow:hidden}
    header{padding:12px 16px;background:#0f172a;color:#fff}
    header h1{margin:0;font-size:18px;line-height:1.3}
    #map{flex:1;min-height:200px;touch-action:manipulation}

    .modal{position:fixed;inset:0;display:flex;align-items:flex-end;justify-content:center;background:rgba(0,0,0,0.55);opacity:0;pointer-events:none;transition:opacity .2s;z-index:1000}
    .modal.open{opacity:1;pointer-events:auto}
    .modal-content{background:#fff;border-radius:16px 16px 0 0;padding:16px;width:100%;max-height:85vh;overflow:auto;box-shadow:0 -4px 20px rgba(2,6,23,.3);transform:translateY(100%);transition:transform .3s ease-out}
    .modal.open .modal-content{transform:translateY(0)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #e5e7eb}
    .modal-header h2{margin:0;font-size:18px;font-weight:600}
    .close-btn{background:#f3f4f6;border:0;font-size:24px;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#374151;transition:background .2s}
    .close-btn:active{background:#e5e7eb}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;padding:4px 0}
    .thumbs a{display:block;position:relative;overflow:hidden;border-radius:8px;background:#f9fafb}
    .thumbs img{width:100%;height:120px;object-fit:cover;display:block;transition:transform .2s}
    .thumbs a:active img{transform:scale(0.95)}

    footer{padding:10px 12px;font-size:12px;background:#f8fafc;text-align:center}
    .muted{color:#6b7280;line-height:1.4}

    /* Tablet and larger */
    @media (min-width:768px){
      header h1{font-size:20px}
      .modal{align-items:center}
      .modal-content{border-radius:12px;max-width:900px;width:94%;max-height:88%;transform:scale(0.9);opacity:0}
      .modal.open .modal-content{transform:scale(1);opacity:1}
      .thumbs{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
      .thumbs img{height:150px}
      .close-btn:hover{background:#e5e7eb}
      .thumbs a:hover img{transform:scale(1.05)}
      footer{font-size:13px}
    }

    /* Larger desktop */
    @media (min-width:1200px){
      .modal-content{max-width:1100px}
      .thumbs{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    }

    /* Improve popup readability on mobile */
    .leaflet-popup-content-wrapper{border-radius:8px;padding:8px}
    .leaflet-popup-content{margin:8px 12px;font-size:14px}
    
    @media (max-width:767px){
      .leaflet-popup-content-wrapper{max-width:280px!important}
      .leaflet-popup-content{margin:6px 10px}
    }
  </style>
</head>
<body>
  <header>
    <h1>üó∫Ô∏è World Map ‚Äî Tap pins to see photos</h1>
  </header>

  <div id="map"></div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 id="modal-title">Photos</h2>
        <button id="close" class="close-btn" aria-label="Close">‚úï</button>
      </div>
      <div id="gallery"></div>
    </div>
  </div>

  <footer>
    <span class="muted">Data from public Google Sheet ‚Ä¢ Tap any pin to view photos</span>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTldb18umlbtlzZgGIgeozfF-oRihc8IVoJ_dSDULPB7mXTRAJSzyk6MAUt5rsW4io92YsZE0Y89U4A/pub?gid=0&single=true&output=csv';

    function collectImages(row){
      const images = [];
      for(let i=1;i<=10;i++){
        const k = 'image'+i;
        if(row[k] && row[k].trim()) images.push(row[k].trim());
      }
      return images;
    }

    const map = L.map('map', {
      tap: true,
      tapTolerance: 20,
      zoomControl: true
    }).setView([20,0], 2);

    // Position zoom controls better on mobile
    map.zoomControl.setPosition('bottomright');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    const modal = document.getElementById('modal');
    const gallery = document.getElementById('gallery');
    const modalTitle = document.getElementById('modal-title');
    const closeBtn = document.getElementById('close');
    
    closeBtn.addEventListener('click', ()=> closeModal());
    modal.addEventListener('click', (e)=> { if(e.target===modal) closeModal(); });

    // Prevent body scroll when modal is open
    function openModal(title, images){
      modalTitle.textContent = title || 'Photos';
      if(!images || images.length===0){
        gallery.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No images available for this location.</p>';
      } else {
        const html = images.map(u => `<a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="${escapeHtml(u)}" alt="photo"/></a>`).join('\n');
        gallery.innerHTML = `<div class="thumbs">${html}</div>`;
      }
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
    
    function escapeHtml(str){ return (str+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

    let COUNTRY_CENTROIDS = {};

    function getLatLon(row){
      const lat = parseFloat(row.lat || row.latitude || row.Lat || row.Latitude);
      const lon = parseFloat(row.lon || row.longitude || row.Lon || row.Longitude);
      if(isFinite(lat) && isFinite(lon)) return [lat, lon];
      const code = (row.country || '').trim().toUpperCase();
      if(code && COUNTRY_CENTROIDS[code]) return COUNTRY_CENTROIDS[code].coordinates;
      return null;
    }

    function loadFromSheet(csvUrl){
      if(!csvUrl || csvUrl.includes('REPLACE_SHEET_ID')){
        console.warn('Please set SHEET_CSV_URL to your published Google Sheet CSV URL.');
        return;
      }

      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results){
          const rows = results.data;
          rows.forEach((row, idx) => {
            const coords = getLatLon(row);
            if(!coords) return;

            const images = collectImages(row);
            const title = COUNTRY_CENTROIDS[row.country?.trim().toUpperCase()]?.name || 'Location';

            const marker = L.marker(coords).addTo(map);
            
            // Open modal on marker click
            marker.on('click', ()=> {
              openModal(title, images);
              map.closePopup(); // Close any open popups
            });

            // Create compact popup for quick preview
            const imageCount = images.length;
            const previewImages = images.slice(0, 3);
            const imagesHtml = previewImages
              .map(u => `<img src="${escapeHtml(u)}" alt="photo" style="width:60px;height:60px;object-fit:cover;border-radius:4px;margin:2px;"/>`)
              .join('');
            
            const popupText = `<div style="text-align:center"><strong>${escapeHtml(title)}</strong><br/><span style="font-size:13px;color:#6b7280">${imageCount} photo${imageCount === 1 ? '' : 's'}</span><br/><div style="margin-top:6px">${imagesHtml}${imageCount > 3 ? '<div style="font-size:12px;color:#9ca3af;margin-top:4px">+' + (imageCount - 3) + ' more</div>' : ''}</div></div>`;

            marker.bindPopup(popupText, {
              maxWidth: 250,
              minWidth: 180,
              closeButton: true
            });
          });
        },
        error: function(err){
          console.error('Error loading CSV:', err);
          alert('Failed to load data. Please check your connection.');
        }
      });
    }

    // Load centroids from external JSON file
    fetch('centroids.json')
      .then(r => r.json())
      .then(data => { COUNTRY_CENTROIDS = data; loadFromSheet(SHEET_CSV_URL); })
      .catch(err => { console.error('Failed to load centroids.json', err); loadFromSheet(SHEET_CSV_URL); });

  </script>
</body>
</html>